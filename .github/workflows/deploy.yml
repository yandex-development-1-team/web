name: Deploy Pages

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'github-pages' || 'gh-pages-develop' }}

    steps:
      # --- Checkout исходной ветки ---
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- Setup Node ---
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # --- Install dependencies ---
      - name: Install dependencies
        run: npm ci

      # --- Build site ---
      - name: Build site
        run: |
          if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
            npm run build
            echo "DEPLOY_PATH=./dist" >> $GITHUB_ENV
          else
            npm run build
            echo "DEPLOY_PATH=./dist" >> $GITHUB_ENV
          fi

      # --- Deploy via git push ---
      - name: Deploy to gh-pages branch
        env:
          GH_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Клонируем ветку gh-pages
          git clone --branch gh-pages https://x-access-token:${GH_PAT}@github.com/${{ github.repository }} gh-pages
          cd gh-pages

          # Копируем старый контент
          cp -r ../$DEPLOY_PATH/* .

          # Если это develop, кладём в папку /preview
          if [ "${GITHUB_REF}" == "refs/heads/develop" ]; then
            mkdir -p preview
            cp -r ../$DEPLOY_PATH/* preview/
          fi

          git add .
          git commit -m "Deploy from $GITHUB_REF"
          git push origin gh-pages
